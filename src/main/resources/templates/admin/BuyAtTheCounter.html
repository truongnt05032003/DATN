<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bán hàng tại quầy</title>

    <link th:href="@{/admin/vendors/themify-icons/css/themify-icons.css}" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

    <script src="https://cdn.tailwindcss.com"></script>
<!--    <script th:src="@{/js/sweetalert.min.js}"></script>-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.3.1/dist/jsQR.js"></script>

    <!--    <script th:src="@{/admin/assets/js/main.js}"></script>-->
    <style>
        * {
            font-family: Arial, Helvetica, sans-serif;
        }

        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            display: none;
        }

        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);

            z-index: 2;
            display: none;
        }

        .loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            border: 4px solid #fff;
            border-top-color: #3498db;
            border-radius: 50%;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            0% {
                transform: translate(-50%, -50%) rotate(0deg);
            }

            100% {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }

        .pos-product:hover {
            cursor: pointer;
            background-color: rgba(9, 100, 207, 0.1);
            box-shadow: 2px 2px 4px #D9D9D9;
            border-color: rgba(9, 100, 207, 0.1);
        }

        .tab-container {
            display: flex;
            align-items: center;
        }

        /* Styling for individual tabs */
        .tab {
            padding: 10px 20px;
            background-color: #11398a;
            border: 1px solid #ccc;
            margin-right: 5px;
            margin-left: 10px;
            position: relative;
            color: #fff;
        }

        .tab.active {
            background-color: #fff;
            color: #000;
        }

        .tab-list {
            display: flex;
        }

        /* Styling for the close button on each tab */
        .close-tab-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            cursor: pointer;
        }

        /* Styling for the plus button to add new tabs */
        .add-tab-btn {
            background: none;
            color: white;
            padding: 10px 15px;
            border: none;
            cursor: pointer;
        }

        .form-group.invalid .form-control {
            border-color: #f33a58;
        }

        /* input[type='number']::-webkit-inner-spin-button,
        input[type='number']::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .custom-number-input input:focus {
            outline: none !important;
        }

        .custom-number-input button:focus {
            outline: none !important;
        }

        .add-customer-form {
            display: none;
        }

        .customer-item {
            cursor: pointer;
        }

        .customer-item.active {
            background-color: #00ccff;
            color: #fff;
        } */
    </style>
</head>

<body>
<div id="overlay"></div>
<div id="loading-overlay">
    <div class="loading-spinner"></div>
</div>
<div class="scan-container z-10 bg-white p-12 rounded-lg shadow-md absolute left-1/4 top-1/4 hidden">
    <video id="qr-video" width="300" height="200" autoplay class="mb-4"></video>
    <canvas id="qr-canvas" width="300" height="200" style="display: none"></canvas>
    <button type="button" class="close-modal-scan absolute top-1 right-1 text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ml-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white"
                                        data-modal-hide="crypto-modal">
                                    <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"
                                         fill="none" viewBox="0 0 14 14">
                                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                              stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6" />
                                    </svg>
                                    <span class="sr-only">Close modal</span>
                                </button>
</div>

<div class="qr-payment-container z-10 bg-white p-x-20 pt-20 pb-10 rounded-lg shadow-md absolute left-1/4 top-1/4 -translate-y-1/4 hidden">
    <img src="" id="qr-payment" width="400" height="300" class="mb-4">
    <button type="button" class="close-modal-payment absolute top-1 right-1 text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ml-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white"
            data-modal-hide="crypto-modal">
        <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"
             fill="none" viewBox="0 0 14 14">
            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                  stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6" />
        </svg>
        <span class="sr-only">Close modal</span>
    </button>
    <div class="flex justify-center">
        <button type="button" class="close-modal-payment outline outline-1 outline-blue-700 hover:outline-blue-800 font-medium rounded-lg text-sm px-5 py-2 me-2 mb-2 dark:outline-blue-600 dark:hover:outline-blue-700">Hủy</button>
        <button id="confirm-pay" type="button" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 dark:bg-blue-600 dark:hover:bg-blue-700 focus:outline-none dark:focus:ring-blue-800">XÁC NHẬN ĐÃ THANH TOÁN</button>
    </div>
</div>


<div id="interactive" class="viewport"></div>
<nav class="" style="background-color: #0964CF; padding: 0 14px">
    <div class="flex items-center">
        <div class="search-container w- mr-2">
            <div class="relative">
                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                    <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" aria-hidden="true"
                         xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z" />
                    </svg>
                </div>
                <input
                        class="pl-10 bg-gray-50 border border-gray-300 text-gray-900 text-sm outline-none rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-1.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                        type="search" placeholder="Thêm sản phẩm vào đơn" aria-label="Search" id="search-product"
                        style="width: 500px">
                <div
                        class="list-search-product hidden bg-white mt-2 rounded-md absolute top-9 px-2 py-2 left-0 z-50 shadow-lg right-0 max-h-80 overflow-y-scroll">

                </div>
                <div class="no-search-found absolute px-2 py-2 hidden bg-white mt-2 rounded-md absolute top-9 px-2 py-2 left-0 z-50 shadow-lg right-0">
                    <span class="text-gray-400 text italic">Không thấy sản phẩm nào</span>
                </div>
            </div>
        </div>
        <div mr-2>
            <a class="text-white cursor-pointer hover:bg-black/[.54] rounded-lg" th:href="@{/admin}">
                <svg class="w-6 h-6 text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none"
                     viewBox="0 0 20 20">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M3 8v10a1 1 0 0 0 1 1h4v-5a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v5h4a1 1 0 0 0 1-1V8M1 10l9-9 9 9" />
                </svg>
            </a>
        </div>
        <div class="ml-4 mr-2 cursor-pointer hover:bg-black/[.54] rounded-lg" id="enable-camera-button">
                <span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 256 256">
                        <path fill="white"
                              d="M232 48v40a8 8 0 0 1-16 0V56h-32a8 8 0 0 1 0-16h40a8 8 0 0 1 8 8ZM72 200H40v-32a8 8 0 0 0-16 0v40a8 8 0 0 0 8 8h40a8 8 0 0 0 0-16Zm152-40a8 8 0 0 0-8 8v32h-32a8 8 0 0 0 0 16h40a8 8 0 0 0 8-8v-40a8 8 0 0 0-8-8ZM32 96a8 8 0 0 0 8-8V56h32a8 8 0 0 0 0-16H32a8 8 0 0 0-8 8v40a8 8 0 0 0 8 8Zm48-16a8 8 0 0 0-8 8v80a8 8 0 0 0 16 0V88a8 8 0 0 0-8-8Zm104 88V88a8 8 0 0 0-16 0v80a8 8 0 0 0 16 0Zm-40-88a8 8 0 0 0-8 8v80a8 8 0 0 0 16 0V88a8 8 0 0 0-8-8Zm-32 0a8 8 0 0 0-8 8v80a8 8 0 0 0 16 0V88a8 8 0 0 0-8-8Z" />
                    </svg>
                </span>
        </div>
        <div class="tab-container" data-tab-number="1">
            <div class="tab-list">
                <div data-tab-number="1" class="tab active font-bold relative cursor-pointer">

                    Đơn <span>1</span>
                </div>
            </div>
            <span class="add-tab-btn h-6 w-6 block hover:bg-gray-700 rounded-full flex justify-center items-center">
                    <div>
                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32">
                            <path fill="white"
                                  d="M16 3C8.832 3 3 8.832 3 16s5.832 13 13 13s13-5.832 13-13S23.168 3 16 3zm0 2c6.087 0 11 4.913 11 11s-4.913 11-11 11S5 22.087 5 16S9.913 5 16 5zm-1 5v5h-5v2h5v5h2v-5h5v-2h-5v-5h-2z" />
                        </svg>
                    </div>
                </span>
        </div>
    </div>
</nav>
<div class="grid grid-cols-6 gaps-2 gap-2  bg-slate-50">
    <div class="container mx-auto col-span-4">

        <div class="h-full product-select-list" style="overflow-y: auto;">

            <div class="relative overflow-x-auto shadow-md sm:rounded-lg">
                <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                    <tr>
                        <th scope="col" class="px-2 py-3">
                            STT
                        </th>
                        <th scope="col" class="px-3 py-3">
                            Ảnh
                        </th>
                        <th scope="col" class="px-6 py-3">
                            Tên sản phẩm
                        </th>
                        <th scope="col" class="px-3 py-3">
                            Màu
                        </th>
                        <th scope="col" class="px-3 py-3">
                            Cỡ
                        </th>
                        <th scope="col" class="px-6 py-3">
                            Số lượng
                        </th>
                        <th scope="col" class="px-6 py-3">
                            Đơn giá
                        </th>
                        <th scope="col" class="px-6 py-3">
                            Thành tiền
                        </th>
                        <th scope="col"></th>
                    </tr>
                    </thead>
                    <tbody data-tab-number="1" class="product-select-body active">

                    </tbody>
                </table>
            </div>

        </div>
    </div>
    <div class="border-solid col-span-2 border-1 border-teal-400 shadow shadow-lg px-4 py-4 min-h-screen">
        <div>
            <div id="currentDateTime" class="flex justify-end">
                <span id="currentDate" class="text-gray-400 mr-3"></span>
                <span id="currentTime" class="text-gray-400"></span>
            </div>
            <div class="search-customer-container w- my-3">
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                        <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" aria-hidden="true"
                             xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                  stroke-width="2" d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z" />
                        </svg>
                    </div>
                    <button id="add-customer-btn" data-modal-target="crypto-modal" data-modal-toggle="crypto-modal"
                            class="absolute inset-y-0 right-0 top-1 flex items-center justify-center inline-block h-8 w-8 mr-2 cursor-pointer rounded-full hover:bg-gray-400">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                            <path fill="currentColor" d="M19 12.998h-6v6h-2v-6H5v-2h6v-6h2v6h6z" />
                        </svg>
                    </button>
                    <input
                            class="pl-10 w-full bg-gray-100 border border-gray-300 text-gray-900 text-md outline-none rounded-lg focus:ring-blue-500 focus:border-blue-500 block px-1.5 py-2 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                            type="text" placeholder="Thêm khách hàng (tùy chọn)" aria-label="Search" id="search-customer">
                    <div id="crypto-modal" tabindex="-1" aria-hidden="true"
                         class="fixed hidden top-0 left-0 right-0 z-50  w-full p-4 overflow-x-hidden overflow-y-auto md:inset-0 h-[calc(100%-1rem)] max-h-full">
                        <div class="relative w-full max-w-md max-h-full left-1/4 top-1/4">
                            <!-- Modal content -->
                            <div class="relative bg-white rounded-lg shadow dark:bg-gray-700">
                                <button type="button"
                                        class="close-modal-customer absolute top-3 right-2.5 text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ml-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white"
                                        data-modal-hide="crypto-modal">
                                    <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"
                                         fill="none" viewBox="0 0 14 14">
                                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                              stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6" />
                                    </svg>
                                    <span class="sr-only">Close modal</span>
                                </button>
                                <!-- Modal header -->
                                <div class="px-6 py-4 border-b rounded-t dark:border-gray-600">
                                    <h3 class="text-base font-semibold text-gray-900 lg:text-xl dark:text-white">
                                        Thêm khách hàng mới
                                    </h3>
                                </div>
                                <!-- Modal body -->
                                <div class="px-6 pt-6">
                                    <form id="add-customer-form">
                                        <div class="mb-4 form-group">
                                            <label for="customerCode"
                                                   class="block mb-1 text-md font-bold text-gray-900 dark:text-white">Mã khách hàng
                                            </label>
                                            <input type="customerCode" name="customerCode" id="customerCode"
                                                   class="bg-gray-50 border border-gray-300 text-gray-900 text-md rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white"
                                                   placeholder="--Tự động nếu bỏ trống--">
                                        </div>
                                        <div class="mb-4 form-group">
                                            <label for="fullName"
                                                   class="block mb-1 text-md font-bold text-gray-900 dark:text-white">Họ và
                                                tên <span class="text-red-500"> *</span></label>

                                            <input type="fullName" name="fullName" id="fullName"
                                                   class="form-control bg-gray-50 border border-gray-300 text-gray-900 text-md rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white"
                                                   placeholder="Nguyen Van A">
                                            <span class="error text-sm text-red-500"></span>
                                        </div>
                                        <div class="form-group">
                                            <label for="phoneNumber"
                                                   class="block mb-1 text-md font-bold text-gray-900 dark:text-white">Số điện thoại<span class="text-red-500"> *</span></label>

                                            <input type="phoneNumber" name="phoneNumber" id="phoneNumber"
                                                   placeholder="012345678"
                                                   class="form-control bg-gray-50 border border-gray-300 text-gray-900 text-md rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white"
                                            >
                                            <span class="error text-sm text-red-500"></span>
                                        </div>
                                        <div class="mt-4 flex items-center justify-end">
                                            <button type="button"
                                                    class="close-modal-customer text-blue-700 bg-white border border-1 border-blue-700 hover:text-blue-800 hover:border-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 mr-2 mb-2">Hủy</button>

                                            <button id="save-customer-btn"
                                                    class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 mb-2">Lưu</button>

                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="list-search-customer hidden absolute bg-white mt-2 rounded-md top-9 px-2 py-2 left-0 z-50 shadow-lg right-0 max-h-80 overflow-y-scroll">

                    </div>
                    <div class="no-search-customer-found px-2 py-2 hidden absolute bg-white mt-2 rounded-md absolute top-9 px-2 py-2 left-0 z-50 shadow-lg right-0">
                        <span class="text-gray-400 text italic">Không thấy khách hàng nào</span>
                    </div>
                </div>
                <div class="selected-customer active mt-2 border border-blue-400 rounded-md">
                    <span class="font-bold italic text-gray-500">--Khách lẻ--</span>
                </div>
            </div>
            <div class=" mb-3">
                <div class="col">
                    <h5 class="">Tổng tiền: </h5>
                </div>
                <div class="col">
                    <h5 class="all-price font-bold text-2xl">0</h5>
                </div>
            </div>
            <div class=" mb-3">
                <div class="col">
                    <h5>Voucher: </h5>
                </div>
                <div class="col">
                    <h6 class="text-red-500 cursor-pointer voucher-choose-btn" >Click vào để chọn</h6>
                    <div class="selected-voucher active"></div>
                </div>
            </div>


            <div id="voucher-modal" tabindex="-1" aria-hidden="true"
                 class="fixed hidden top-0 left-0 right-0 z-50  w-full p-4 overflow-x-hidden overflow-y-auto md:inset-0 h-[calc(100%-1rem)] max-h-full">
                <div class="relative w-full max-w-md max-h-full left-1/4 top-1/4">
                    <!-- Modal content -->
                    <div class="relative bg-white rounded-lg shadow dark:bg-gray-700">
                        <button type="button"
                                class="close-modal-voucher absolute top-3 right-2.5 text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ml-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white"
                                data-modal-hide="voucher-modal">
                            <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"
                                 fill="none" viewBox="0 0 14 14">
                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                      stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6" />
                            </svg>
                            <span class="sr-only">Close modal</span>
                        </button>
                        <!-- Modal header -->
                        <div class="px-6 py-4 border-b rounded-t dark:border-gray-600">
                            <h3 class="text-base font-semibold text-gray-900 lg:text-xl dark:text-white">
                                Chọn mã giảm giá
                            </h3>
                        </div>
                        <!-- Modal body -->
                        <div class="px-6 py-6 vourcher-list max-h-80 overflow-y-auto">
                            <div class="flex items-center shadow hover:bg-gray-100 dark:bg-gray-800 dark:border-gray-700 dark:hover:bg-gray-700 rounded cursor-pointer mb-2">
                                <div class="flex items-center justify-center rounded w-14 bg-blue-100 h-20 mr-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M12.79 21L3 11.21v2c0 .53.21 1.04.59 1.41l7.79 7.79c.78.78 2.05.78 2.83 0l6.21-6.21c.78-.78.78-2.05 0-2.83L12.79 21z"/><path fill="currentColor" d="M11.38 17.41c.78.78 2.05.78 2.83 0l6.21-6.21c.78-.78.78-2.05 0-2.83L12.63.58A2.04 2.04 0 0 0 11.21 0H5C3.9 0 3 .9 3 2v6.21c0 .53.21 1.04.59 1.41l7.79 7.79zM7.25 3a1.25 1.25 0 1 1 0 2.5a1.25 1.25 0 0 1 0-2.5z"/></svg>
                                </div>
<!--                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M20.04 8.71V4h-4.7L12 .69L8.71 4H4v4.71L.69 12L4 15.34v4.7h4.71L12 23.35l3.34-3.31h4.7v-4.7L23.35 12l-3.31-3.29M8.83 7.05c.98 0 1.77.79 1.77 1.78a1.77 1.77 0 0 1-1.77 1.77c-.99 0-1.78-.79-1.78-1.77c0-.99.79-1.78 1.78-1.78M15.22 17c-.98 0-1.77-.8-1.77-1.78a1.77 1.77 0 0 1 1.77-1.77c.98 0 1.78.79 1.78 1.77A1.78 1.78 0 0 1 15.22 17m-6.72.03L7 15.53L15.53 7l1.5 1.5l-8.53 8.53Z"/></svg>-->

                                <div class="w-full">
                                    <p class="font-bold">Giảm <span>10K</span></p>
                                    <p class="text-black text-sm">Cho đơn từ </p>
                                    <span class="mr-2 text-sm text-gray-600">HSD: </span> <span class="text-sm text-gray-600">Đã dùng: </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <div class=" mb-3 hidden">
                <div class="col">
                    <h6>Giảm giá sản phẩm: </h6>
                </div>
                <div class="col">
                    <h6 id="product-discount">0</h6>
                </div>
            </div>
            <div class="">
                <div class="col">
                    <h6>Giảm giá voucher: </h6>
                </div>
                <div class="col">
                    <h6 id="voucher-discount">0</h6>
                </div>
            </div>
            <hr>
            <div class=" mb-3 mt-2">
                <div class="col">
                    <h5 class="font-bold">Khách phải trả: </h5>
                </div>
                <div class="col">
                    <h5 class="font-bold text-blue-500 text-2xl" id="last-price">0</h5>
                </div>
            </div>
            <div class="">
                <div class="col">
                    <h6 class="font-bold">Tiền khách đưa: </h6>
                </div>
                <div class="col">
                    <input class="border-none outline-none bg-transparent text-xl" type="text" name=""
                           id="customerPayInput">
                </div>
            </div>
            <hr>
            <div class="mt-2">
                <div class="col">
                    <h6 class="text-blue-500">Tiền thừa trả khách: </h6>
                </div>
                <div class="col">
                    <h6 class="text-xl" id="money-change">0</h6>
                </div>
            </div>

            <div class="payment-method-group mt-4">
                <input type="radio" th:value="1" name="paymentMethod" id="payment-offline" checked> <label
                    class="mr-2">Tiền
                mặt</label>
                <!-- <input type="radio" th:value="4" name="paymentMethod" id="payment-card"> <label
                class="mr-2">Thẻ</label> -->
                <input type="radio" value="3" name="paymentMethod" id="payment-online"> <label class="mr-2">Chuyển
                khoản</label>
            </div>

            <button
                    class="text-white w-full bg-gradient-to-r from-blue-500 via-blue-600 to-blue-700 hover:bg-gradient-to-br focus:ring-4 focus:outline-none focus:ring-blue-300 dark:focus:ring-blue-800 font-bold rounded-lg text-2xl px-5 py-4 mt-3 text-center"
                    id="submitBtn" type="button">THANH TOÁN
            </button>

        </div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
                th:inline="javascript"></script>
        <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
        <script th:src="@{/admin/assets/js/validator.js}"></script>
        <script th:inline="javascript">
            $(document).ready(() => {


                updateTime()
                function updateTime() {
                    var currentDate = new Date();
                    var formattedDate = formatDate(currentDate);
                    var hours = currentDate.getHours();
                    var minutes = currentDate.getMinutes();
                    var seconds = currentDate.getSeconds();
                    // Format the time
                    hours = hours < 10 ? "0" + hours : hours;
                    minutes = minutes < 10 ? "0" + minutes : minutes;
                    var currentTime = hours + ":" + minutes

                    $('#currentDate').text(formattedDate)
                    $("#currentTime").text(currentTime)
                }

                // Update the time every minute (60000 milliseconds)
                setInterval(updateTime, 60000);
                function formatDate(date) {
                    var options = { day: '2-digit', month: '2-digit', year: 'numeric' };
                    return date.toLocaleDateString('en-GB', options);
                }
            })
        </script>
        <script th:inline="javascript">


            $(document).ready(() => {
                let voucherChoosed;
                var maxQuantiyAllow=99999999;
                let tabQuantity = 1;
                var currentUserRole = /*[[${#authentication.getPrincipal().getAuthorities()}]]*/ [];
                if(currentUserRole[0].authority == 'ROLE_EMPLOYEE') {
                    maxQuantiyAllow = 20;
                }

                $('.tab').click(function () {
                    // Xóa class "active" khỏi tất cả các tab
                    $('.tab-container .tab').removeClass('active');

                    // Thêm class "active" cho tab mới được nhấp
                    $(this).addClass('active');

                    $('.product-select-body').addClass('hidden');
                    $('.product-select-body').removeClass('active')
                    $('.selected-customer').addClass('hidden');
                    $('.selected-customer').removeClass('active')
                    document.querySelector('.product-select-body').classList.remove('hidden')
                    document.querySelector('.product-select-body').classList.add('active')
                    document.querySelector('.selected-customer').classList.remove('hidden')
                    document.querySelector('.selected-customer').classList.add('active')
                    calculateAllPrice()
                    voucherChoosed = null
                    $('#customerPayInput').val('')
                    pay.customerPay = 0
                    $('#money-change').text(0)
                    calculateVoucherPrice()
                    calculateLastPrice()
                });

                // Bắt sự kiện click nút "Thêm tab"
                $('.add-tab-btn').click(function () {

                    // Set mở tối đa 7 tab
                    if($('.tab').length > 6) {
                        Toastify({
                            text: "Bạn chỉ được mở tối đa 7 đơn",
                            className: "error",
                            style: {
                                background: "red",
                            }
                        }).showToast();
                        return
                    }
                    // Lấy số thứ tự hiện tại của tab cuối cùng
                    var lastTabNumber = parseInt($('.tab-container .tab:last-child').attr('data-tab-number'));

                    // Tạo một tab mới với số thứ tự tăng dần
                    var newTab = $(`<div data-tab-number="${lastTabNumber + 1}" class="tab font-bold relative cursor-pointer">
                            Đơn <span> ${lastTabNumber + 1}</span>
                            <div class="remove-tab-btn absolute top-0.5 right-0 cursor-pointer">
                            <svg class="" xmlns="http://www.w3.org/2000/svg" width="12" height="12"
                                viewBox="0 0 32 32">
                                <path fill="currentColor"
                                    d="M16 2C8.2 2 2 8.2 2 16s6.2 14 14 14s14-6.2 14-14S23.8 2 16 2zm5.4 21L16 17.6L10.6 23L9 21.4l5.4-5.4L9 10.6L10.6 9l5.4 5.4L21.4 9l1.6 1.6l-5.4 5.4l5.4 5.4l-1.6 1.6z" />
                            </svg>
                        </div>
                            </div>`);

                    // Thêm tab mới vào danh sách
                    $('.tab-list').append(newTab);
                    var body  = $(`<tbody data-tab-number="${lastTabNumber + 1}" class="product-select-body hidden"></tbody>`)
                    $('table').append(body)

                    var selectedCustomer = $(`<div class="selected-customer mt-2 border border-blue-400 rounded-md hidden">
<span class="font-bold italic text-gray-500">--Khách lẻ--</span>
</div>`)
                    $('.search-customer-container').append(selectedCustomer)
                    // Bắt sự kiện click trên tab mới
                    newTab.on('click', function () {
                        $('.tab-container .tab').removeClass('active');
                        $('.product-select-body').addClass('hidden');
                        $('.product-select-body').removeClass('active')
                        $('.selected-customer').addClass('hidden');
                        $('.selected-customer').removeClass('active')
                        body.addClass('active')
                        body.removeClass('hidden')
                        newTab.addClass('active');
                        selectedCustomer.addClass('active')
                        selectedCustomer.removeClass('hidden')

                        calculateAllPrice()
                        voucherChoosed = null
                        $('#customerPayInput').val('')
                        pay.customerPay = 0
                        $('#money-change').text(0)
                        calculateVoucherPrice()
                        calculateLastPrice()
                    });

                    // Bắt sự kiện click nút "Xóa tab"
                    $('.remove-tab-btn').on('click', function (e) {
                        e.stopPropagation()
                        // // Lấy số thứ tự của tab cần xóa
                        var tabNumber = parseInt($(this).closest('.tab').attr('data-tab-number'));

                        // Xóa tab
                        $(this).parent().remove();
                        var element = $(`.product-select-body[data-tab-number = '${tabNumber}'`);
                        // var previousElement = element.prev('.product-select-body');
                        // previousElement.addClass('active')
                        // previousElement.removeClass('hidden')
                        if(element.hasClass('active')) {
                            $(`.tab[data-tab-number='${tabNumber-1}']`).addClass('active')
                            $(`.product-select-body[data-tab-number='${tabNumber-1}']`).addClass('active')
                            $(`.product-select-body[data-tab-number='${tabNumber-1}']`).removeClass('hidden')
                            calculateAllPrice()
                            calculateLastPrice()
                        }
                        element.remove()
                    })
                    // // Cập nhật số thứ tự của tab cuối cùng
                    // $('.tab-container').attr('data-tab-number', lastTabNumber + 1);
                });




                // Handle search product
                var debounceTimer;
                $("#search-product").on('input', function () {
                    if (debounceTimer) {
                        clearTimeout(debounceTimer);
                    }
                    var searchKey = $(this).val().trim()
                    if (searchKey == "") {
                        $(".list-search-product").html('')
                        return
                    }
                    debounceTimer = setTimeout(async function () {
                        await $.ajax({
                            method: 'GET',
                            dateType: 'json',
                            url: `/api/products/filter?keyword=${searchKey}`,
                            contentType: "application/json; charset=utf-8",
                            success: function (data) {
                                loadProductSearch(data)
                            },
                            error: function (xhr, status, error) {
                                Swal.fire({
                                    title: "Lỗi",
                                    text: xhr.responseJSON.message,
                                    icon: "error"
                                });
                            }
                        })
                    }, 500)
                })

                $("#search-product").on('focus', function () {
                    if($(this).val().trim() != "") {
                        $('.no-search-found').addClass('hidden')
                        $('.list-search-product').removeClass('hidden')
                    }
                })

                $(document).on('click', function (e) {
                    if (!$(".search-container").is(e.target) && $(".search-container").has(e.target).length === 0) {
                        // Click occurred outside of the element
                        $('.list-search-product').addClass('hidden');
                        $('.no-search-found').addClass('hidden')
                    }

                    if (!$(".search-customer-container").is(e.target) && $(".search-customer-container").has(e.target).length === 0) {
                        // Click occurred outside of the element
                        $('.list-search-customer').addClass('hidden');
                        $('.no-search-customer-found').addClass('hidden')
                    }
                })

                var productList = []

                function handleAddToOrder(productDetailSe, productDetailId, canAdd, product) {
                    if (productDetailSe.quantity == 0) {
                        Toastify({
                            text: "Sản phẩm này đã hết",
                            className: "error",
                            style: {
                                background: "red",
                            }
                        }).showToast();
                        return 1;
                    }

                    $(".product-select-body.active .product-select-item").each((index, element) => {
                        const item = $(element);
                        const itemProductDetailId = item.attr('data-product-detail-id');
                        //Kiểm tra trong danh sách lựa chọn có chưa, nếu có rồi sẽ tăng thêm 1
                        if (itemProductDetailId == productDetailId) {
                            const input = item.find('input');
                            var currentVal = input.val();
                            var nextVal = parseInt(currentVal) + 1;
                            input.val(nextVal);

                            // Kiểm tra số lượng tối đa trước khi thêm
                            const maxQuan = parseInt(item.attr('product-max-quan'));
                            if (nextVal > maxQuan) {
                                Swal.fire({
                                    title: "Lỗi",
                                    text: "Số lượng tối đa của sản phẩm này là " + maxQuan,
                                    icon: "error"
                                });
                                input.val(maxQuan);
                            }

                            // Tính lại
                            const productPrice = removeAnyNonDigit(item.find('.product-select-price').text());
                            const totalPrice = nextVal * parseFloat(productPrice);
                            const totalPriceProductEl = item.find('.total-price-product');
                            totalPriceProductEl.text(formatNumber(totalPrice));

                            calculateAllPrice();
                            calculateLastPrice();

                            // Set có thể thêm một product mới được không để chuẩn bị append html vào select list
                            canAdd = false;
                        }
                    })

                    if (!canAdd) {
                        return;
                    }


                    // productSelecting.push(productDetailSe)
                    const productPrice = formatNumber(productDetailSe.price)
                    const discountedPrice = productDetailSe.discountedPrice
                    var discountedPriceFormatted
                    var htmlPrice = ''
                    if(discountedPrice) {
                        discountedPriceFormatted = formatNumber(discountedPrice)
                        htmlPrice = `<td class=" px-6 py-4 text-lg">
                                        <span class="flex flex-col">
                                            <span class="text-sm line-through">${productPrice}</span>
                                            <span class="text-lg product-select-price">${discountedPriceFormatted}</span>
                                        </span>
                                </td>
                                <td class="total-price-product px-6 py-4 text-blue-400 font-bold text-lg">
                                    ${discountedPriceFormatted}
                                </td>`
                    }else  {
                        htmlPrice = `<td class="product-select-price px-6 py-4 text-lg">
                                    ${productPrice}
                                </td>
                                <td class="total-price-product px-6 py-4 text-blue-400 font-bold text-lg">
                                    ${productPrice}
                                </td>`
                    }

                    var htmlProductItem = $(`<tr data-product-id="${product.id}" data-product-detail-id="${productDetailSe.id}" data-max-quan="${productDetailSe.quantity}" class="bg-white border-b text-gray-700 product-select-item">
                                <th scope="row"
                                    class="order-number px-2 py-3 font-bold text-gray-900 whitespace-nowrap dark:text-white text-xl">

                                </th>
                                <td class="px-3 py-4 text-lg">
                                    <img src="/${product.imageUrl}" alt="" width="50px">
                                </td>
                                <td class="px-6 py-4 text-base">
                                    ${product.name}
                                </td>
                                <td class="px-3 py-4 text-base">
                                    ${productDetailSe.color.name}
                                </td>
                                <td class="px-3 py-4 text-base">
                                    ${productDetailSe.size.name}
                                </td>
                                <td class="px-6 py-4 text-lg">
                                    <div class="custom-number-input h-10 w-32">
                                        <div class="flex flex-row h-10 w-full rounded-lg relative bg-transparent mt-1">

                                            <input type="number"
                                                class="product-select-quantity outline-none focus:outline-none text-center w-full bg-gray-200 font-semibold text-md hover:text-black focus:text-black  md:text-basecursor-default flex items-center text-gray-700  outline-none"
                                                name="custom-input-number${productDetailSe.id}" value="1" min="1"></input>

                                        </div>
                                    </div>
                                </td>

                                ${htmlPrice}

                            </tr> `)
                    var deleteButton = $(`<td class="px-6 py-4">
                                    <span
                                        class="remove-select-item cursor-pointer hover:bg-gray-200 block w-8 h-8 rounded-full font-medium text-danger-600 dark:text-danger-500 hover:underline flex items-center">
                                        <svg class="w-6 h-6 text-gray-800 dark:text-white flex-1" aria-hidden="true"
                                            xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 18 20">
                                            <path stroke="red" stroke-linecap="round" stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M1 5h16M7 8v8m4-8v8M7 1h4a1 1 0 0 1 1 1v3H6V2a1 1 0 0 1 1-1ZM3 5h12v13a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V5Z" />
                                        </svg>
                                    </span>
                                </td>`)
                    htmlProductItem.append(deleteButton)
                    $('.product-select-body.active').append(htmlProductItem)

                    // Chèn thêm số thứ tự
                    loadOrdreNumber()

                    calculateAllPrice()
                    calculateLastPrice()

                    deleteButton.on('click', () => {
                        const productItem = deleteButton.parent()
                        productItem.remove()
                        // const idToRemove = productItem.attr('data-product-detail-id')
                        // productSelecting = productSelecting.filter(item => item.id != idToRemove)
                        loadOrdreNumber()

                        calculateAllPrice()
                        calculateLastPrice()
                    })

                    handleChangeQuantity()
                }

                function handleChangeQuantity() {
                    // HANDLE CHANGE QUANITTY
                    $('.product-select-quantity').on('keydown', function (e) {
                        onlyAllowNumberInput(e)
                    })

                    $('.product-select-quantity').on('focusout', function () {
                        if($(this).val() == 0 || $(this).val() == "") {
                            $(this).val(1)
                            $(this).trigger("change")
                        }
                    })
                    $('.product-select-quantity').on('input change', function (e) {

                        var val;
                        if($(this).val() == "") {
                            val = 1
                        }else  {
                            val = parseInt($(this).val())
                        }
                        const productItem = $(this).parent().parent().parent().parent()
                        const maxQuan = parseInt(productItem.attr('data-max-quan'))
                        if (val > maxQuan) {
                            Swal.fire({
                                title: "Lỗi",
                                text: "Số lượng tối đa của sản phẩm này là " + maxQuan,
                                icon: "error"
                            });
                            $(this).val(maxQuan)
                        }

                        if(val > maxQuantiyAllow) {
                            Swal.fire({
                                title: "Lỗi",
                                text: "Bạn chỉ được cho phép bán tối đa " + maxQuantiyAllow,
                                icon: "error"
                            });
                            $(this).val(maxQuantiyAllow)
                        }

                        const productPrice = removeAnyNonDigit(productItem.find('.product-select-price').text())
                        const totalPrice = val * parseFloat(productPrice)
                        const totalPriceProductEl = productItem.find('.total-price-product')
                        totalPriceProductEl.text(formatNumber(totalPrice))


                        calculateAllPrice()
                        calculateLastPrice()
                    })
                }

                function loadProductSearch(data) {
                    productList = data.content;
                    if (productList.length > 0) {
                        $('.no-search-found').addClass('hidden')
                        $('.list-search-product').removeClass('hidden')
                        var html = '';
                        productList.forEach(product => {
                            product.productDetailDtos.forEach(productDetail => {
                                var price = ``
                                if(productDetail.discountedPrice) {
                                    price = `<span>
                                                <span class="product-old-price text-sm line-through text-gray-500 italic">${productDetail.price}</span>
                                                <span class="product-price text-md font-bold text-blue-500">${productDetail.discountedPrice}</span>
                                            </span>`
                                }
                                else {
                                    price = `<span>
                                                <span class="product-price text-md font-bold text-blue-500">${productDetail.price}</span>
                                            </span>`
                                }
                                html += `<div class="search-product-item-container hover:bg-blue-50 rounded-sm cursor-pointer">
                            <div data-product-id="${product.id}" data-product-detail-id="${productDetail.id}" class="search-product-item flex items-center px-2 py-2 ">
                                <div class="image-container w-12 mr-2">
                                    <img class="w-full" src="/${product.imageUrl}" alt="">
                                </div>
                                <div class="search-product-info flex-1">
                                    <div class="flex justify-between">
                                        <h5 class="product-name font-bold">${product.name}</h5>
                                        <span class="product-code text-gray-600 text-sm">#${product.code}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-400 text-sm">
                                            <span>Màu: </span> <span>${productDetail.color.name}</span>
                                        </span>
                                        <span class="text-gray-400 text-sm">
                                            <span>Cỡ: </span> <span>${productDetail.size.name}</span>
                                        </span>

                                        <span class="text-sm">
                                            <span>Tồn: </span> <span class="product-quantity">${productDetail.quantity}</span>
                                        </span>
                                        ${price}
                                    </div>
                                </div>
                            </div>
                        </div > `
                            })
                        })
                        $(".list-search-product").html(html)

                        var productSelecting = []


                        //============================ HANDLE SELECT =================
                        $('.search-product-item').on('click', async function () {
                            var productId = $(this).attr('data-product-id')
                            var productDetailId = $(this).attr('data-product-detail-id')
                            var productDetailList = []
                            var product = {};
                            var canAdd = true
                            await productList.forEach(x => {
                                if (x.id == productId) {
                                    productDetailList = x.productDetailDtos;
                                    product = x
                                }
                            })

                            var productDetailSe = productDetailList.find(x => x.id == productDetailId)

                            handleAddToOrder(productDetailSe, productDetailId, canAdd, product);

                        })

                    }
                    else {
                        $(".list-search-product").html('')
                        $('.no-search-found').removeClass('hidden')
                    }
                }

                function loadOrdreNumber() {
                    var productSelectItems = document.querySelectorAll('.product-select-body.active .product-select-item')
                    productSelectItems.forEach((item, index) => {
                        var stt = index + 1;
                        item.querySelector('.order-number').textContent = stt.toString()
                    })
                }

                var allPrice = document.querySelector('.all-price')
                var lastPrice = document.querySelector('#last-price')
                var productDiscount = document.getElementById("product-discount")
                var voucherDiscount = document.getElementById("voucher-discount")
                var pay = {
                    id: 1,
                    totalMoney: 0,
                    vourcher: '',
                    discount: '',
                    requireMoney: 0,
                    customerPay: '',
                    customerChange: 0
                }

                function resetPayArea() {
                    allPrice.innerText = '0'
                    lastPrice.innerText = '0'
                    $("#customerPayInput").val(0)
                    $("#money-change").text(0)
                    $("#search-product").val('')
                }

                function calculateAllPrice() {
                    var totalPrice = 0;
                    document.querySelectorAll('.product-select-body.active .product-select-item').forEach(item => {
                        totalPrice += parseFloat(item.querySelector('.total-price-product').textContent.replace(/[^0-9]/g, ''))
                    })
                    pay.totalMoney = totalPrice;
                    allPrice.innerText = formatNumber(totalPrice)
                    calculateVoucherPrice()
                }

                function calculateVoucherPrice() {
                    if(voucherChoosed) {
                        if(pay.totalMoney < voucherChoosed.minimumAmountInCart) {
                            $('.selected-voucher.active').html('')
                            $('.selected-voucher.active').attr('selected-id', '')
                            voucherChoosed = null
                            return
                        }
                        if(voucherChoosed.percentage) {
                            var value = Math.round(pay.totalMoney * voucherChoosed.percentage / 100)
                            if(value > voucherChoosed.maximumAmount) {
                                pay.vourcher = voucherChoosed.maximumAmount
                            }
                            else {
                                pay.vourcher = value
                            }
                            voucherDiscount.innerText = formatNumber(pay.vourcher)
                        }else {
                            if(voucherChoosed.discountAmount) {
                                voucherDiscount.innerText = formatNumber(voucherChoosed.discountAmount)

                            }
                        }
                    }else {
                        voucherDiscount.innerText = '0'
                        calculateLastPrice()
                    }
                }

                function calculateLastPrice() {

                    var lastPriceValue = parseFloat(allPrice.textContent.replace(/[^0-9]/g, '')) - parseFloat(productDiscount.textContent.replace(/[^0-9]/g, '')) - parseFloat(voucherDiscount.textContent.replace(/[^0-9]/g, ''))
                    if (lastPriceValue > 0) {
                        lastPrice.innerText = formatNumber(lastPriceValue.toString())
                        pay.requireMoney = lastPriceValue
                        pay.customerChange = pay.customerPay - pay.requireMoney
                        if(pay.customerPay > 0) {
                            updateCustomerChange()
                        }
                    }
                    else {
                        lastPrice.innerText = '0'
                        pay.requireMoney = 0;
                    }
                }


                $('#add-customer-btn').on('click', function () {
                    $('#overlay').show()
                    $('#crypto-modal').removeClass('hidden')
                })

                $('.close-modal-customer').click(() => {
                    $('#overlay').hide()
                    $('#crypto-modal').addClass('hidden')

                })


                function formatNumber(number) {
                    return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
                }

                $("#customerPayInput").on('input', function () {

                    var value = $(this).val();
                    if (value.length > 15) {
                        $(this).val('')
                        pay.customerPay = 0
                        updateCustomerChange()
                        return;
                    }
                    value = removeAnyNonDigit(value)
                    pay.customerPay = value

                    updateCustomerChange()

                    $(this).val(formatNumber(value))
                })

                function removeAnyNonDigit(value) {
                    return value.replace(/\D/g, '');
                }

                function updateCustomerChange() {
                    pay.customerChange = pay.customerPay - pay.requireMoney
                    if(pay.customerChange > 0) {
                        $("#money-change").text(formatNumber(pay.customerChange))
                    }
                    else {
                        $("#money-change").text(0)

                    }
                }

                function updateTotalMoney() {

                }


                // Handle search product
                var debounceTimerCus;
                $("#search-customer").on('input', function () {
                    if (debounceTimerCus) {
                        clearTimeout(debounceTimerCus);
                    }
                    var searchKey = $(this).val().trim()
                    if (searchKey == "") {
                        $(".list-search-customer").html('')
                        return
                    }
                    debounceTimerCus = setTimeout(async function () {
                        await $.ajax({
                            method: 'GET',
                            type: 'json',
                            url: `/api/customer/filter?keyword=${searchKey}&size=10`,
                            contentType: "application/json; charset=utf-8",
                            success: function (data) {
                                loadCustomerSearch(data)
                            },
                            error: function (xhr, status, error) {
                                Swal.fire({
                                    title: "Lỗi",
                                    text: xhr.responseJSON.message,
                                    icon: "error"
                                });
                            }
                        })
                    }, 500)
                })

                function loadHtmlCustomerSelected(customerId, customerName, customerCode, customerPhone) {
                    $('.selected-customer.active').attr('selected-id', customerId)
                    $('.selected-customer.active').html(`
                        <div class="p-2 flex items-center justify-between">
                            <div>
                                <span class="font-bold">
                                    ${customerName}
                                </span>
                                <br>
                                <span class="text-gray-400">
                                    ${customerCode}
                                </span>
                            </div>
                            <div>
                                <span class="font-bold">
                                    ${customerPhone}
                                </span>
                            </div>
                              <span id="delete-selected-customer-btn" class="p-1 hover:bg-gray-400 rounded-full font-bold cursor-pointer">&times</span>
                        </div>
                        `)

                    $('#delete-selected-customer-btn').click(() => {
                        $('.selected-customer.active').html('<span class="font-bold italic text-gray-500">--Khách lẻ--</span>')
                        $('.selected-customer.active').attr('selected-id', "")
                    })
                }

                function loadCustomerSearch(data) {
                    var customerList = data.content;
                    console.log(customerList)
                    if (customerList.length > 0) {
                        $('.no-search-customer-found').addClass('hidden')
                        $('.list-search-customer').removeClass('hidden')
                        var html = '';
                        customerList.forEach(item => {
                            html += `<div class="search-customer-item-container hover:bg-blue-50 rounded-sm cursor-pointer">
                            <div class="search-customer-item p-2 flex justify-between items-center" data-customer-id="${item.id}">
                                <div>
                                    <span class="font-bold text-md customer-name">${item.name}</span> <br>
                                    <span class="text-gray-500 text-sm customer-code">#${item.code}</span>
                                </div>
                                <div>
                                    <span class="font-bold text-md customer-phone">${item.phoneNumber}</span>
                                </div>
                            </div>
                        </div>`
                        })
                        $('.list-search-customer').html(html)

                        // var customerInfo = {}
                        $('.search-customer-item').on('click', function(e) {
                            var item = $(e.currentTarget);
                            var customerCode = item.find('.customer-code').text()
                            var customerName = item.find('.customer-name').text()
                            var customerPhone = item.find('.customer-phone').text()
                            var customerId = item.attr('data-customer-id');
                            // customerInfo.code = customerCode;
                            // customerInfo.name = customerName;
                            // customerInfo.phone = customerPhone;
                            // customerInfo.id =

                            $(".list-search-customer").addClass('hidden')
                            loadHtmlCustomerSelected(customerId, customerName, customerCode, customerPhone);
                        })

                    }
                    else {
                        $(".list-search-customer").html('')
                        $('.no-search-customer-found').removeClass('hidden')
                    }
                }

                $("#search-customer").on('focus', function () {
                    if($(this).val().trim() != "") {
                        $('.no-search-customer-found').addClass('hidden')
                        $('.list-search-customer').removeClass('hidden')
                    }
                })

                // Event handler for customerPhone input to allow only numeric characters
                $("#phoneNumber").on('keypress', function (e) {
                    const key = e.key;
                    if (!/[\d\b]/.test(key)) {
                        e.preventDefault();
                    }
                });

                Validator({
                    form: '#add-customer-form',
                    formGroupSelector: '.form-group',
                    errorSelector: '.error',
                    rules: [
                        Validator.isRequired('#fullName', 'Vui lòng nhập họ tên'),
                        Validator.isRequired('#phoneNumber', 'Vui lòng nhập số điện thoại'),
                        Validator.maxLength('#fullName', 100),
                        Validator.maxLength('#phoneNumber', 10),
                    ],
                    onSubmit: async function (data) {
                        var dataSend = {
                            code: data.customerCode,
                            name: data.fullName,
                            phoneNumber: data.phoneNumber
                        }

                        await $.ajax({
                            type: 'POST',
                            dataType: 'json',
                            contentType: "application/json; charset=utf-8",
                            url: '/api/customer',
                            data: JSON.stringify(dataSend),
                            success: function (data) {
                                $('#overlay').hide()
                                $('#crypto-modal').addClass('hidden')

                                $(".list-search-customer").addClass('hidden')
                                loadHtmlCustomerSelected(data.id, data.name, data.code, data.phoneNumber);
                            },
                            error: function (xhr, status, error) {
                                Swal.fire({
                                    title: "Lỗi",
                                    text: xhr.responseJSON.message,
                                    icon: "error"
                                });
                            }
                        })
                    }
                });

                // // Event handler for save customer button
                // $('#save-customer-btn').on('click', async function () {
                //     const customerCode = $("#customerCode").val().trim()
                //     const customerName = $("#fullName").val().trim()
                //     const customerPhone = $("#phoneNumber").val().trim()
                //     // if (customerName == "" || customerName == null) {
                //     //     Swal.fire({
                //     //         title: "Lỗi",
                //     //         text: "Vui lòng nhập họ tên khách hàng",
                //     //         icon: "error"
                //     //     });
                //     //     return
                //     // }
                //
                //
                // })

                //========================== XỬ LÝ VOUCHER ======================
                $(".voucher-choose-btn").on('click', async function () {
                    $('#loading-overlay').show();
                    await $.ajax({
                        type: 'GET',
                        url: `/api/private/discount-code-valid?sort=start_date,desc`,
                        dataType: 'json',
                        success: function (data) {
                            const voucherList = data.content;
                            loadHtmlVoucherSelectList(voucherList);
                            $('#loading-overlay').hide();
                            $('#overlay').show()
                            $('#voucher-modal').removeClass('hidden')

                        },
                        error: function () {
                            Swal.fire({
                                title: "Lỗi",
                                text: "Có lỗi xảy ra",
                                icon: "error"
                            })
                            $('#loading-overlay').hide();

                        }
                    })
                })

                function loadHtmlVoucherSelectList(voucherList) {
                    var html = ''
                    if(voucherList.length > 0) {
                        voucherList.forEach(item => {
                            var amount = parseInt(item.discountAmount);
                            var minimumAmountInCart = parseInt(item.minimumAmountInCart);
                            var type = item.type
                            var endDate = new Date(item.endDate);
                            const formattedDate = endDate.toLocaleDateString('en-GB');

                            var svg = ''
                            var maximumAmount = item.maximumAmount
                            var htmlMaxAmount = ''
                            var htmlAmount = ''
                            if (type == 1) {
                                svg = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                                            <path fill="currentColor" d="M20.04 8.71V4h-4.7L12 .69L8.71 4H4v4.71L.69 12L4 15.34v4.7h4.71L12 23.35l3.34-3.31h4.7v-4.7L23.35 12l-3.31-3.29M8.83 7.05c.98 0 1.77.79 1.77 1.78a1.77 1.77 0 0 1-1.77 1.77c-.99 0-1.78-.79-1.78-1.77c0-.99.79-1.78 1.78-1.78M15.22 17c-.98 0-1.77-.8-1.77-1.78a1.77 1.77 0 0 1 1.77-1.77c.98 0 1.78.79 1.78 1.77A1.78 1.78 0 0 1 15.22 17m-6.72.03L7 15.53L15.53 7l1.5 1.5l-8.53 8.53Z"/>
                                       </svg>`
                                htmlAmount = `<p class="font-bold">Giảm <span>${item.percentage}%</span></p>`
                            }
                            if(type == 2) {
                                svg = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M12.79 21L3 11.21v2c0 .53.21 1.04.59 1.41l7.79 7.79c.78.78 2.05.78 2.83 0l6.21-6.21c.78-.78.78-2.05 0-2.83L12.79 21z"/><path fill="currentColor" d="M11.38 17.41c.78.78 2.05.78 2.83 0l6.21-6.21c.78-.78.78-2.05 0-2.83L12.63.58A2.04 2.04 0 0 0 11.21 0H5C3.9 0 3 .9 3 2v6.21c0 .53.21 1.04.59 1.41l7.79 7.79zM7.25 3a1.25 1.25 0 1 1 0 2.5a1.25 1.25 0 0 1 0-2.5z"/></svg>`
                                htmlAmount = `<p class="font-bold">Giảm <span>${amount} đ</span></p>`
                            }

                            if(maximumAmount) {
                                htmlMaxAmount = `<span class="ml-2">Giảm tối đa: ${maximumAmount}</span>`
                            }

                            html+=`<div data-voucher="${item.id}" class="flex items-center shadow hover:bg-gray-100 dark:bg-gray-800 dark:border-gray-700 dark:hover:bg-gray-700 rounded cursor-pointer mb-2 voucher-item">
                                <div class="flex items-center justify-center rounded w-14 bg-blue-100 h-20 mr-2">
                                    ${svg}
                                </div>

                                <div class="w-full">
                                    ${htmlAmount}
                                    <p class="text-black text-sm">Cho đơn từ ${minimumAmountInCart} ${htmlMaxAmount}</p>
                                    <span class="mr-2 text-sm text-gray-600">HSD: ${formattedDate}</span> <span class="text-sm text-gray-600">Còn: ${item.maximumUsage}</span>
                                </div>
                            </div>`
                        })
                    }
                    else html = '<div class="font-italic text-gray-400">Không có mã giảm giá nào</div>'
                    $('.vourcher-list').html(html)

                    handleClickVoucher(voucherList)
                }

                function handleClickVoucher(voucherList) {
                    //Xử lý chọn voucher
                    $('.voucher-item').on('click', function () {
                        const voucherId = $(this).attr('data-voucher')
                        const item = voucherList.find(item => item.id == voucherId)
                        if(item.minimumAmountInCart > parseFloat(removeAnyNonDigit(allPrice.textContent))) {
                            Swal.fire({
                                title: "Lỗi",
                                text: "Giá trị đơn hàng không đủ để áp dụng mã giảm giá này",
                                icon: "error"
                            })
                            return
                        }
                        voucherChoosed = item
                        var amount;
                        var minimumAmountInCart = parseInt(item.minimumAmountInCart);
                        var type = item.type
                        var endDate = new Date(item.endDate);
                        const formattedDate = endDate.toLocaleDateString('en-GB');

                        var svg = ''
                        var textHead = ''
                        var maximumAmount = item.maximumAmount
                        var htmlMaxAmount = ''

                        if (type == 1) {
                            amount = parseInt(item.percentage);
                            textHead = `<p class="font-bold text-sm">Giảm <span>${amount}%</span></p>`
                            svg = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                                            <path fill="currentColor" d="M20.04 8.71V4h-4.7L12 .69L8.71 4H4v4.71L.69 12L4 15.34v4.7h4.71L12 23.35l3.34-3.31h4.7v-4.7L23.35 12l-3.31-3.29M8.83 7.05c.98 0 1.77.79 1.77 1.78a1.77 1.77 0 0 1-1.77 1.77c-.99 0-1.78-.79-1.78-1.77c0-.99.79-1.78 1.78-1.78M15.22 17c-.98 0-1.77-.8-1.77-1.78a1.77 1.77 0 0 1 1.77-1.77c.98 0 1.78.79 1.78 1.77A1.78 1.78 0 0 1 15.22 17m-6.72.03L7 15.53L15.53 7l1.5 1.5l-8.53 8.53Z"/>
                                       </svg>`
                        }
                        if(type == 2) {
                            amount = parseInt(item.discountAmount);
                            textHead = `<p class="font-bold text-sm">Giảm <span>${amount}</span></p>
`
                            svg = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M12.79 21L3 11.21v2c0 .53.21 1.04.59 1.41l7.79 7.79c.78.78 2.05.78 2.83 0l6.21-6.21c.78-.78.78-2.05 0-2.83L12.79 21z"/><path fill="currentColor" d="M11.38 17.41c.78.78 2.05.78 2.83 0l6.21-6.21c.78-.78.78-2.05 0-2.83L12.63.58A2.04 2.04 0 0 0 11.21 0H5C3.9 0 3 .9 3 2v6.21c0 .53.21 1.04.59 1.41l7.79 7.79zM7.25 3a1.25 1.25 0 1 1 0 2.5a1.25 1.25 0 0 1 0-2.5z"/></svg>
`
                        }

                        if(maximumAmount) {
                            htmlMaxAmount = `<span class="ml-2">Giảm tối đa: ${maximumAmount}</span>`
                        }

                        var html = `<div class="p-2 flex items-center justify-between border border-blue-400 relative">
                                        <div class="flex items-center justify-center rounded w-14 bg-blue-100 h-10 mr-2">
                                            ${svg}
                                        </div>

                                        <div class="w-full">
                                            ${textHead}
                                            <p class="text-black text-sm">Cho đơn từ ${minimumAmountInCart} ${htmlMaxAmount}</p>
                                        </div>
                                        <span class="absolute right-1 top-1 close-voucher-btn cursor-pointer">&times;</span>
                                    </div>
                                    `
                        $('.selected-voucher.active').attr('selected-id', voucherId)
                        $('.selected-voucher.active').html(html)

                        $('#overlay').hide()
                        $('#voucher-modal').addClass('hidden')

                        calculateAllPrice()
                        calculateLastPrice()
                        closeModalVoucher()

                        // Click xóa voucher
                        $('.close-voucher-btn').on('click', function () {
                            $('.selected-voucher.active').html('')
                            $('.selected-voucher.active').attr('selected-id', '')
                            voucherChoosed = null
                            calculateVoucherPrice()
                        })
                    })
                }

                // Đóng modal chọn voucher
                $('.close-modal-voucher').on('click', closeModalVoucher)
                function closeModalVoucher() {
                    $('#overlay').hide()
                    $('#voucher-modal').addClass('hidden')
                }

                //===========================================ẤN NÚT THANH TOÁN=====================
                $('#submitBtn').on('click', handleSubmit);

                var dataSendIfChuyenKhoan
                async function handleSubmit() {
                    const customerId = $(".selected-customer.active").attr("selected-id") || ""
                    const voucherId = $(".selected-voucher.active").attr("selected-id") || ""
                    var orderDetails = []
                    $(".product-select-body.active .product-select-item").each(function () {
                        orderDetails.push({
                            productDetailId: $(this).attr("data-product-detail-id"),
                            quantity: $(this).find(".product-select-quantity").val()
                        })
                    })

                    if (orderDetails.length <= 0) {
                        Swal.fire({
                            title: "Lỗi",
                            text: "Đơn hiện tại trống",
                            icon: "error"
                        });
                        return;
                    }

                    if(pay.customerPay == '') {
                        Swal.fire({
                            title: "Lỗi",
                            text: "Vui lòng nhập số tiền khách đưa",
                            icon: "error"
                        });
                        return;
                    }

                    const promotionPrice = parseInt(removeAnyNonDigit($("#voucher-discount").text())) + parseInt(removeAnyNonDigit($("#product-discount").text()))

                    var paymentMethodId = $('input[name="paymentMethod"]:checked').val()

                    var dataSend = {
                        customer: {
                            id: customerId
                        },
                        paymentMethodId: paymentMethodId,
                        billingAddress: "",
                        promotionPrice: promotionPrice,
                        voucherId: voucherId,
                        orderDetailDtos: orderDetails
                    };

                    // Xử lý khi pt thanh toán là chuyển khoản
                    if (paymentMethodId == 3) {
                        $(".qr-payment-container").removeClass('hidden');
                        $(".qr-payment-container").find('img').attr("src", `https://img.vietqr.io/image/TCB-19037422831012-compact2.jpg?amount=${pay.requireMoney}&addInfo=Thanh%20%20toan%20don%20hang&accountName=Nguyen%20Ngoc%20Sang`);
                        dataSendIfChuyenKhoan = dataSend;
                    } else {
                        // Execute the AJAX request directly for other payment methods
                        await handleAjaxRequest(dataSend);
                    }
                }

                // Gọi thanh toán
                async function handleAjaxRequest(dataSend) {
                    //============================================== XỬ LÝ THANH TOÁN =============================================
                    $('#loading-overlay').show();
                    await $.ajax({
                        type: 'POST',
                        url: '/api/orderAdmin',
                        data: JSON.stringify(dataSend),
                        contentType: "application/json; charset=utf-8",
                        success: async function (data) {
                            $('#loading-overlay').hide();
                            $(".product-select-body.active").html('')
                            resetPayArea()
                            Toastify({
                                text: "Thanh toán thành công",
                                className: "info",
                                style: {
                                    background: "linear-gradient(to right, #00b09b, #96c93d)",
                                }
                            }).showToast();

                            //Lấy bill vừa lưu
                            var generateUrl = `/admin/generate-pdf/${data.billId}`;
                            // Fetch the HTML content from the controller
                            await fetch(generateUrl)
                                .then(response => response.text())
                                .then(htmlContent => {

                                    // Config máy in
                                    var printWindow = window.open('', '', 'width=800,height=1000');
                                    printWindow.document.open();

                                    printWindow.document.write(htmlContent);
                                    printWindow.document.close();
                                    printWindow.print();

                                })
                                .catch(error => {
                                    $('#loading-overlay').hide();
                                    Swal.fire({
                                        title: "Lỗi",
                                        text: "Lỗi export pdf phía server",
                                        icon: "error"
                                    });
                                });
                        },
                        error: function (xhr, status, error) {
                            $('#loading-overlay').hide();
                            Swal.fire({
                                title: "Lỗi",
                                text: xhr.responseJSON.message,
                                icon: "error"
                            });
                        }
                    })
                }

                $("#confirm-pay").click(function () {
                    handleAjaxRequest(dataSendIfChuyenKhoan);
                });

                // Xử lý click nút close modal khi chuyển khoản
                $(".close-modal-payment").click(function () {
                    $(".qr-payment-container").addClass('hidden');

                })

                // Format dạng 1.000
                function formatNumber(number) {
                    return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
                }

//-------------------------- ========XỬ LÝ QUÉT MÃ========== ================================-----------------------------------------------------
                var video = document.getElementById("qr-video");
                var canvas = document.getElementById("qr-canvas");
                var ctx = canvas.getContext("2d");
                var enableCameraButton = document.getElementById("enable-camera-button");
                var stream;

                enableCameraButton.addEventListener("click", function () {
                    if (!stream) {
                        $(".scan-container").removeClass('hidden')
                        navigator.mediaDevices
                            .getUserMedia({ video: true })
                            .then(function (cameraStream) {
                                stream = cameraStream;
                                video.srcObject = stream;
                                video.play();
                                startScanning();
                            })
                            .catch(function (error) {
                                Swal.fire({
                                    title: "Error",
                                    text: "Error accessing the camera:" + error,
                                    icon: "error"
                                });
                            });
                    } else {
                        stream.getTracks().forEach(function (track) {
                            track.stop();
                        });
                        video.srcObject = null;
                        stream = null;
                    }
                });

                $('.close-modal-scan').click(function() {
                    $(".scan-container").addClass('hidden')
                    if (stream) {
                        stream.getTracks().forEach(function (track) {
                            track.stop();
                        });
                        video.srcObject = null;
                        stream = null;
                    }
                })

                function startScanning() {
                    let scanInterval;

                    function scanBarcode() {
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                        var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        var code = jsQR(imageData.data, imageData.width, imageData.height);

                        if (code) {
                            // Clear the interval when a code is found
                            clearInterval(scanInterval);

                            $.ajax({
                                type: 'GET',
                                dataType: 'json',
                                url: `/api/products/getByBarcode?barcode=${code.data}`,
                                success: function (data) {
                                    var productDetail = data.productDetailDtos[0];
                                    var result = handleAddToOrder(productDetail, productDetail.id, true, data);
                                    var text = ''
                                    if(result == 1) {
                                        Swal.fire({
                                            title: "Thông báo",
                                            text: "Sản phẩm này đã hết",
                                            icon: "error"
                                        }).then((result) => {
                                            if(result.isConfirmed) {
                                                scanInterval = setInterval(scanBarcode, 60);
                                            }
                                        });
                                    }else {
                                        Swal.fire({
                                            title: "Thông báo",
                                            text: "Thêm sản phẩm mới thành công",
                                            icon: "success"
                                        }).then((result) => {
                                            if(result.isConfirmed) {
                                                scanInterval = setInterval(scanBarcode, 60);
                                            }
                                        });
                                    }

                                },
                                error: function (xhr, status, error) {
                                    Swal.fire({
                                        title: "Lỗi",
                                        text: xhr.responseJSON.message,
                                        icon: "error"
                                    }).then((result) => {
                                        if(result.isConfirmed) {
                                            scanInterval = setInterval(scanBarcode, 60);
                                        }
                                    })
                                }
                            });
                        }
                    }

                    // Start the initial scan interval
                    scanInterval = setInterval(scanBarcode, 60);
                }
            })

        </script>
        <script th:inline="javascript">

            //current ROle
            var currentUserRole = /*[[${#authentication.getPrincipal().getAuthorities()}]]*/ [];
            function onlyAllowNumberInput(e) {
                const key = e.key;
                if (key === '-') {
                    e.preventDefault();
                }
            }
        </script>
    </div>
</div>
</body>

</html>